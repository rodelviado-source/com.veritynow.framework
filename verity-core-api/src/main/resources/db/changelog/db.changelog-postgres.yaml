databaseChangeLog:
  - changeSet:
      id: 0001-postgres-ltree-extension
      author: veritynow
      preConditions:
        onFail: MARK_RAN
        - dbms:
            type: postgresql
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE EXTENSION IF NOT EXISTS ltree;

  # ----------------------------
  # Core store tables
  # ----------------------------
  - changeSet:
      id: 0010-core-inode
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_inode
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_inode
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  constraints:
                    nullable: false
              - column:
                  name: scope_key
                  type: LTREE
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE UNIQUE INDEX IF NOT EXISTS uq_vn_inode_scope_key ON vn_inode(scope_key);

  - changeSet:
      id: 0011-core-dir-entry
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_dir_entry
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_dir_entry
                    nullable: false
              - column:
                  name: parent_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: child_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: vn_dir_entry
            baseColumnNames: parent_id
            referencedTableName: vn_inode
            referencedColumnNames: id
            constraintName: fk_vn_dir_parent
            onDelete: RESTRICT
        - addForeignKeyConstraint:
            baseTableName: vn_dir_entry
            baseColumnNames: child_id
            referencedTableName: vn_inode
            referencedColumnNames: id
            constraintName: fk_vn_dir_child
            onDelete: RESTRICT
        - addUniqueConstraint:
            tableName: vn_dir_entry
            columnNames: parent_id, name
            constraintName: uq_dir_parent_name
        - createIndex:
            tableName: vn_dir_entry
            indexName: ix_dir_parent
            columns:
              - column:
                  name: parent_id
        - createIndex:
            tableName: vn_dir_entry
            indexName: ix_dir_child
            columns:
              - column:
                  name: child_id

  - changeSet:
      id: 0012-core-inode-path-segment
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_inode_path_segment
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_inode_path_segment
                    nullable: false
              - column:
                  name: inode_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: ord
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: dir_entry_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMPTZ
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: vn_inode_path_segment
            baseColumnNames: inode_id
            referencedTableName: vn_inode
            referencedColumnNames: id
            constraintName: fk_vn_inode_path_inode
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: vn_inode_path_segment
            baseColumnNames: dir_entry_id
            referencedTableName: vn_dir_entry
            referencedColumnNames: id
            constraintName: fk_vn_inode_path_dir_entry
            onDelete: CASCADE
        - addUniqueConstraint:
            tableName: vn_inode_path_segment
            columnNames: inode_id, ord
            constraintName: uq_inode_ord
        - createIndex:
            tableName: vn_inode_path_segment
            indexName: ix_inode_path_inode
            columns:
              - column:
                  name: inode_id

  - changeSet:
      id: 0013-core-node-version
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_node_version
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_node_version
                    nullable: false
              - column:
                  name: inode_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: timestamp
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: path
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: operation
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: principal
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: correlation_id
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: workflow_id
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: context_name
                  type: TEXT
              - column:
                  name: transaction_id
                  type: TEXT
              - column:
                  name: transaction_result
                  type: TEXT
              - column:
                  name: hash
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: mime_type
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: size
                  type: BIGINT
                  constraints:
                    nullable: false
        - addForeignKeyConstraint:
            baseTableName: vn_node_version
            baseColumnNames: inode_id
            referencedTableName: vn_inode
            referencedColumnNames: id
            constraintName: fk_vn_version_inode
            onDelete: CASCADE
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE INDEX IF NOT EXISTS ix_ver_inode_timestamp
              ON vn_node_version(inode_id, timestamp DESC, id DESC);

  - changeSet:
      id: 0014-core-node-head
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_node_head
            columns:
              - column:
                  name: id
                  type: BIGINT
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_node_head
                    nullable: false
              - column:
                  name: inode_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: version_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMPTZ
                  constraints:
                    nullable: false
              - column:
                  name: fence_token
                  type: BIGINT
        - addForeignKeyConstraint:
            baseTableName: vn_node_head
            baseColumnNames: inode_id
            referencedTableName: vn_inode
            referencedColumnNames: id
            constraintName: fk_vn_head_inode
            onDelete: CASCADE
        - addForeignKeyConstraint:
            baseTableName: vn_node_head
            baseColumnNames: version_id
            referencedTableName: vn_node_version
            referencedColumnNames: id
            constraintName: fk_vn_head_version
            onDelete: RESTRICT
        - addUniqueConstraint:
            tableName: vn_node_head
            columnNames: inode_id
            constraintName: uq_vn_node_head_inode

  # ----------------------------
  # Locking + txn tables (Postgres)
  # ----------------------------
  - changeSet:
      id: 0020-locking-seq
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE SEQUENCE IF NOT EXISTS vn_fence_token_seq;

  - changeSet:
      id: 0021-lock-group
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_lock_group
            columns:
              - column:
                  name: lock_group_id
                  type: UUID
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_lock_group
                    nullable: false
              - column:
                  name: owner_id
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: fence_token
                  type: BIGINT
              - column:
                  name: active
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: acquired_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: expires_at
                  type: TIMESTAMPTZ
              - column:
                  name: released_at
                  type: TIMESTAMPTZ
        - createIndex:
            tableName: vn_lock_group
            indexName: ix_vn_lock_group_owner_active
            columns:
              - column:
                  name: owner_id
              - column:
                  name: active
        - createIndex:
            tableName: vn_lock_group
            indexName: ix_vn_lock_group_active_expires
            columns:
              - column:
                  name: active
              - column:
                  name: expires_at

  - changeSet:
      id: 0022-path-lock
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_path_lock
            columns:
              - column:
                  name: id
                  type: BIGSERIAL
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_path_lock
                    nullable: false
              - column:
                  name: lock_group_id
                  type: UUID
                  constraints:
                    nullable: false
              - column:
                  name: owner_id
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: scope_key
                  type: LTREE
                  constraints:
                    nullable: false
              - column:
                  name: active
                  type: BOOLEAN
                  defaultValueBoolean: true
                  constraints:
                    nullable: false
              - column:
                  name: acquired_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
              - column:
                  name: released_at
                  type: TIMESTAMPTZ
        - addForeignKeyConstraint:
            baseTableName: vn_path_lock
            baseColumnNames: lock_group_id
            referencedTableName: vn_lock_group
            referencedColumnNames: lock_group_id
            constraintName: fk_vn_path_lock_group
            onDelete: CASCADE
        - createIndex:
            tableName: vn_path_lock
            indexName: ix_vn_path_lock_owner_active
            columns:
              - column:
                  name: owner_id
              - column:
                  name: active
        - createIndex:
            tableName: vn_path_lock
            indexName: ix_vn_path_lock_group
            columns:
              - column:
                  name: lock_group_id
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              CREATE INDEX IF NOT EXISTS ix_vn_path_lock_scope_key_gist
              ON vn_path_lock USING GIST(scope_key);

  - changeSet:
      id: 0023-txn-epoch
      author: veritynow
      preConditions:
        onFail: HALT
        - dbms:
            type: postgresql
      changes:
        - createTable:
            tableName: vn_txn_epoch
            columns:
              - column:
                  name: txn_id
                  type: TEXT
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vn_txn_epoch
                    nullable: false
              - column:
                  name: lock_group_id
                  type: UUID
              - column:
                  name: fence_token
                  type: BIGINT
              - column:
                  name: status
                  type: TEXT
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: TIMESTAMPTZ
                  defaultValueComputed: now()
                  constraints:
                    nullable: false
        - createIndex:
            tableName: vn_txn_epoch
            indexName: ix_vn_txn_epoch_status
            columns:
              - column:
                  name: status

  # ----------------------------
  # Bootstrap root inode row
  # ----------------------------
  - changeSet:
      id: 0030-bootstrap-root-inode
      author: veritynow
      preConditions:
        onFail: MARK_RAN
        - dbms:
            type: postgresql
        - sqlCheck:
            expectedResult: "0"
            sql: |
              select count(*)::text from vn_inode where scope_key = cast('root' as ltree);
      changes:
        - sql:
            splitStatements: false
            stripComments: true
            sql: |
              insert into vn_inode(created_at, scope_key)
              values (now(), cast('root' as ltree));
