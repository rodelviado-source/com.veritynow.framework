create schema if not exists "public";
create extension if not exists ltree;

create table "public"."vn_blob" ("hash" varchar(255) not null, "hash_algorithm" varchar(255) not null, "size" bigint not null, "mime_type" varchar(255), "name" varchar(255), constraint "vn_blob_pkey" primary key ("hash", "hash_algorithm"));
create table "public"."vn_dir_entry" ("child_id" bigint not null, "created_at" timestamp(6) with time zone not null default now(), "id" bigint generated by default as identity not null, "parent_id" bigint not null, "name" varchar(255) not null, constraint "vn_dir_entry_pkey" primary key ("id"), constraint "uq_dir_parent_name" unique ("parent_id", "name"));
create table "public"."vn_inode" ("created_at" timestamp(6) with time zone not null default now(), "id" bigint generated by default as identity not null, "scope_key" "public"."ltree", constraint "vn_inode_pkey" primary key ("id"), constraint "uq_vn_inode_scope_key" unique ("scope_key"));
create table "public"."vn_inode_path_segment" ("ord" int not null, "created_at" timestamp(6) with time zone not null default now(), "dir_entry_id" bigint not null, "id" bigint generated by default as identity not null, "inode_id" bigint not null, constraint "vn_inode_path_segment_pkey" primary key ("id"), constraint "uq_inode_ord" unique ("inode_id", "ord"));
create table "public"."vn_node_head" ("inode_id" bigint not null, "updated_at" timestamp(6) with time zone not null default now(), "version_id" bigint not null, constraint "vn_node_head_pkey" primary key ("inode_id"));
create table "public"."vn_node_version" ("id" bigint generated by default as identity not null, "inode_id" bigint not null, "size" bigint not null, "timestamp" bigint not null default ((EXTRACT(epoch FROM CURRENT_TIMESTAMP) * (1000)::numeric))::bigint, "context_name" varchar(255), "correlation_id" varchar(255), "hash_algorithm" varchar(255), "hash" varchar(255), "mime_type" varchar(255), "name" varchar(255), "operation" varchar(255), "path" varchar(255), "principal" varchar(255), "transaction_id" varchar(255), "transaction_result" varchar(255), "workflow_id" varchar(255), constraint "vn_node_version_pkey" primary key ("id"));
create index "ix_dir_child" on "public"."vn_dir_entry"("child_id");
create index "ix_dir_parent" on "public"."vn_dir_entry"("parent_id");
create index "ix_vn_inode_scope_key_gist" on "public"."vn_inode"("scope_key");
create index "ix_inode_path_dir_entry" on "public"."vn_inode_path_segment"("dir_entry_id");
create index "ix_inode_path_inode" on "public"."vn_inode_path_segment"("inode_id");
create index "ix_ver_correlation" on "public"."vn_node_version"("correlation_id", "id");
create index "ix_ver_hash_alg" on "public"."vn_node_version"("hash", "hash_algorithm");
create index "ix_ver_inode_timestamp" on "public"."vn_node_version"("inode_id", "timestamp" desc, "id" desc);
create index "ix_ver_txn_inode" on "public"."vn_node_version"("transaction_id", "inode_id", "id");
create index "ix_ver_txn_result" on "public"."vn_node_version"("transaction_id", "transaction_result", "id");
create index "ix_ver_workflow" on "public"."vn_node_version"("workflow_id", "id");
alter table "public"."vn_dir_entry" add constraint "vn_dir_entry_child_id_fk" foreign key ("child_id") references "public"."vn_inode" ("id") on delete no action on update no action;
alter table "public"."vn_dir_entry" add constraint "vn_dir_entry_parent_id_fk" foreign key ("parent_id") references "public"."vn_inode" ("id") on delete no action on update no action;
alter table "public"."vn_inode_path_segment" add constraint "vn_inode_path_segment_dir_entry_id_fk" foreign key ("dir_entry_id") references "public"."vn_dir_entry" ("id") on delete no action on update no action;
alter table "public"."vn_inode_path_segment" add constraint "vn_inode_path_segment_inode_id_fk" foreign key ("inode_id") references "public"."vn_inode" ("id") on delete no action on update no action;
alter table "public"."vn_node_head" add constraint "vn_node_head_inode_id_fk" foreign key ("inode_id") references "public"."vn_inode" ("id") on delete no action on update no action;
alter table "public"."vn_node_head" add constraint "vn_node_head_version_id_fk" foreign key ("version_id") references "public"."vn_node_version" ("id") on delete no action on update no action;
alter table "public"."vn_node_version" add constraint "vn_node_version_inode_id_fk" foreign key ("inode_id") references "public"."vn_inode" ("id") on delete no action on update no action;
